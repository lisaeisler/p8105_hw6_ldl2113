---
title: "Homework 6"
author: "Lisa Eisler"
date: "11/22/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(readxl)
library(haven)
library(plotly)
library(viridis)
library(broom)
library(purrr)
library(modelr)
library(mgcv)

set.seed(1)
```

## Problem 1

Read in and clean birthweight data for regression. Create dichotomous maternal race variable for regression (black vs. non-black/unknown).

```{r, message=FALSE}
birthweight_data = read_csv(file = "./data/birthweight.csv") %>% 
  janitor::clean_names() %>%
  mutate(
    babysex = factor(babysex, levels =  c("1", "2"), labels = c("male", "female")),
    frace = factor(frace, levels =  c("1", "2", "3", "4", "8", "9"), labels = c("white", "black", "asian", "puerto rican", "other", "unknown")),
    malform = factor(malform, levels =  c("0", "1"), labels = c("absent", "present")),
    mrace = factor(mrace, levels =  c("1", "2", "3", "4", "8"), labels = c("white", "black", "asian", "puerto rican", "other"))
  ) %>%
  mutate(mblack = ifelse(mrace == "black", "true", "false"))
birthweight_data
```

```{r}
sum(!complete.cases(birthweight_data))
```

*There are no missing data*

Propose a regression model for birthweight. This model may be based on a hypothesized structure for the factors that underly birthweight, on a data-driven model-building process, or a combination of the two. Describe your modeling process. 

*Based on my clinical in the delivery room and NICU, I propose that birthweight is modeled by the following factors: gestationl age, length, head circumference, smoking status, income, and the number of prior low birthweight babies born to the mother. I will also include maternal race (black/non-black) given recent NYtimes coverage of the healthcare disparities impacting black mothers and their babies even after other factors such as SES are accounted for*

```{r, message=FALSE} 
bwtmodel_1 = lm(bwt ~ gaweeks + bhead + blength + smoken + fincome + pnumlbw, data = birthweight_data) 
bwtmodel_1 %>% 
summary()
```

*show table with parameters and p-value*

```{r}
bwtmodel_1 %>%
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 5)
```

Show a plot of model residuals against fitted values.

```{r, message=FALSE, echo=FALSE} 
birthweight_data %>%
modelr::add_residuals(bwtmodel_1) %>%
modelr::add_predictions(bwtmodel_1) %>% 
ggplot(aes(x = pred, y = resid)) + geom_point(alpha = 0.5) + 
           geom_hline(yintercept = 0, color = "blue") + 
  labs(
    title = "Plot of model residuals against fitted values",
    x = "Predicted Birtweight (grams)",
    y = "Residuals"
   )
```

Create comparison models: One using length at birth and gestational age as predictors (main effects only) and one using head circumference, length, sex, and all interactions (including the three-way interaction) between these.

```{r, message=FALSE} 
bwtmodel_2 = lm(bwt ~ gaweeks + blength, data = birthweight_data) 
bwtmodel_3 = lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex + bhead * blength * babysex, data = birthweight_data)
```

Make a comparison of these two models with your model in terms of the cross-validated prediction error.

```{r, echo=FALSE, warning=FALSE} 
cv_bwtmodels =
  crossv_mc(birthweight_data, 100) %>%
    mutate( 
      train = map(train, as_tibble),
      test = map(test, as_tibble)
    )

cv_bwtmodels = 
  cv_bwtmodels %>%
    mutate(
      bwtmodel_1  = map(train, ~lm(bwt ~ gaweeks + bhead + blength + smoken + fincome + pnumlbw, data = .x)),
      bwtmodel_2  = map(train, ~lm(bwt ~ gaweeks + blength, data = .x)),
      bwtmodel_3  = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex + bhead * blength * babysex, data = as_tibble(.x)))) %>% 
    mutate(
      rmse_bwtmodel_1 = map2_dbl(bwtmodel_1, test, ~rmse(model = .x, data = .y)),
      rmse_bwtmodel_2   = map2_dbl(bwtmodel_2, test, ~rmse(model = .x, data = .y)),
      rmse_regmodel_3 = map2_dbl(bwtmodel_3, test, ~rmse(model = .x, data = .y)))

cv_bwtmodels %>% 
  select(starts_with("rmse")) %>% 
pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse,  fill = model)) + geom_violin(alpha = 0.5) 
```

* Based on RMSE, the model I developed (bwtmodel_1) appears to be the best fit for the data, and in addition contains a moderate amount of complexity compared with models 2 (too simple) and 3 (too complex with interaction terms).*